<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Plan Preview - AI Race Planner</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        .hero {
            background: linear-gradient(135deg, #FF5722 0%, #FF9800 100%);
            color: white;
            padding: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            z-index: 1;
            /* Ensure it stays below sticky header if any, but above background */
        }

        .segment-card {
            border-left: 5px solid #ddd;
            transition: all 0.2s;
        }

        .segment-card.Climb {
            border-left-color: #FF5722;
            background-color: #fff5f2;
        }

        .segment-card.Descent {
            border-left-color: #2196F3;
            background-color: #e3f2fd;
        }

        .segment-card.Flat {
            border-left-color: #4CAF50;
        }

        .surf-badge {
            font-size: 0.7rem;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .surf-Paved {
            background: #eee;
            color: #555;
        }

        .surf-Gravel {
            background: #795548;
            color: #fff;
        }

        .surf-Dirt {
            background: #5D4037;
            color: #fff;
        }

        .big-watt {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .cue-text {
            font-size: 0.9rem;
            color: #666;
        }

        /* Sticky Footer for Download */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #eee;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }

        .spacer {
            height: 80px;
        }
    </style>
</head>

<body class="bg-light">

    <div class="hero text-center mb-4">
        <h3>Race Plan Preview</h3>
        <p class="mb-0 text-white-50">Strategy for {{ route_name }}</p>
    </div>

    <div class="container" style="max-width: 600px;">
        <!-- Stats Summary -->
        <div class="card mb-4 shadow-sm">
            <div class="card-body text-center d-flex justify-content-between">
                <div>
                    <div class="text-muted small">Time</div>
                    <div class="fw-bold">{{ total_time_str }}</div>
                </div>
                <div>
                    <div class="text-muted small">Avg Power</div>
                    <div class="fw-bold">{{ avg_power }}W</div>
                </div>
                <div>
                    <div class="text-muted small">Carbs</div>
                    <div class="fw-bold">{{ total_carbs }}g</div>
                </div>
            </div>
        </div>

        {% if delusion_level and delusion_level > 0 %}
        <div class="alert alert-warning text-center p-2 mb-4 shadow-sm" style="font-size: 0.9rem;">
            <strong>⚠️ Delusion Level {{ delusion_level }}</strong>
            <br>
            Using {{ effective_cp }}W (+{{ delusion_level }}%)
            <br>
            <span class="small">Good luck holding this!</span>
        </div>
        {% endif %}

        <!-- Map Container -->
        <div id="map"></div>

        <h6 class="text-muted mb-3 ms-2">Directives</h6>

        {% for seg in segments %}
        <div class="card mb-3 shadow-sm segment-card {{ seg.type_class }}">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-secondary">{{ seg.start_dist_km }} km</span>
                    <span class="surf-badge surf-{{ seg.surface }}">{{ seg.surface }}</span>
                </div>

                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="mb-0">{{ seg.type }}</h5>
                        <div class="cue-text">{{ seg.duration_str }} • Avg Grad {{ seg.avg_grad }}%</div>
                    </div>
                    <div class="text-end">
                        <div class="big-watt">{{ seg.power }}<span class="small text-muted"
                                style="font-size:0.8rem">W</span></div>
                        <div class="small text-muted">Target</div>
                    </div>
                </div>

                {% if seg.notes %}
                <div class="mt-2 text-muted small border-top pt-2">
                    <i class="bi bi-info-circle"></i> {{ seg.notes }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <div class="spacer"></div>
    </div>

    <div class="sticky-footer text-center">
        <!-- Re-submit same params to generate file -->
        <form action="/generate_file" method="POST">
            <input type="hidden" name="route_url" value="{{ request.form.route_url }}">
            <input type="hidden" name="gear_id" value="{{ request.form.gear_id }}">
            <input type="hidden" name="rider_mass" value="{{ request.form.rider_mass }}">
            <input type="hidden" name="cp" value="{{ request.form.cp }}">
            <input type="hidden" name="w_prime" value="{{ request.form.w_prime }}">
            <input type="hidden" name="delusion" value="{{ request.form.delusion }}">
            <button type="submit" class="btn btn-primary btn-lg w-100 shadow">
                Download Device File (.TCX)
            </button>
        </form>
    </div>

</body>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    // Initialize Map
    // We need to find valid bounds first, so we defer setView.
    var map = L.map('map');

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // Load Data
    var mapSegments = {{ map_data | tojson }};

    var allPoints = [];

    if (mapSegments && mapSegments.length > 0) {
        mapSegments.forEach(function (seg) {
            if (seg.points && seg.points.length > 0) {
                // Leaflet Polylines
                var polyline = L.polyline(seg.points, {
                    color: seg.color,
                    weight: 5,
                    opacity: 0.8,
                    lineJoin: 'round'
                }).addTo(map);

                if (seg.popup) {
                    polyline.bindPopup(seg.popup);
                }

                // Add points to bounds
                seg.points.forEach(p => allPoints.push(p));
            }
        });

        // Fit Bounds
        if (allPoints.length > 0) {
            map.fitBounds(allPoints, { padding: [20, 20] });
        }
    } else {
        // Fallback or Empty
        map.setView([0, 0], 2);
    }
</script>

</html>